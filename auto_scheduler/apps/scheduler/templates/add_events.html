<!--
    Name: apps/scheduler/templates/addEvents.html
    Description: HTML template extension for the add events page.
    Authors: Kiara Grimsley, Ella Nguyen
    Created: November 7, 2025
    Last Modified: November 8, 2025
-->

{# auto_scheduler/apps/scheduler/templates/add_events.html #}
{% extends "base.html" %}
{% block content %}

<h2 class="mb-2">Add Events</h2>
<p class="text-sm text-muted">Imported events loaded: {{ imported_count|default:0 }}</p>

<form method="post" id="task-formset">
  {% csrf_token %}
  {{ formset.management_form }}

  <div id="forms-container">
    {% for form in formset %}
      <div class="task-card" data-form-index="{{ forloop.counter0 }}" style="border:1px solid #ddd;padding:12px;margin-bottom:10px;border-radius:8px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div>
            <label>Title</label>
            {{ form.title }}
          </div>
          <div>
            <label>Duration (min)</label>
            {{ form.duration_minutes }}
          </div>
          <div>
            <label>Priority</label>
            {{ form.priority }}
          </div>
          <div>
            <label>Event Type</label>
            {{ form.event_type }}
        </div>
        </div>

        <div style="margin-top:8px;">
            <label>Description</label><br>
            {{ form.description }}
        </div>

        <details style="margin-top:8px;">
          <summary>Optional constraints</summary>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;">
            <div>
              <label>Earliest Date</label>
              {{ form.date_start }}
            </div>
            <div>
              <label>Latest Date</label>
              {{ form.date_end }}
            </div>
            <div>
              <label>Earliest Time</label>
              {{ form.time_start }}
            </div>
            <div>
              <label>Latest Time</label>
              {{ form.time_end }}
            </div>
            <div style="display:flex;align-items:flex-end;gap:8px;">
              <div>
                <label>{{ form.split }} Split?</label>
              </div>
              <div>
                <label>Split size (min)</label>
                {{ form.split_minutes }}
              </div>
            </div>
          </div>
        </details>
      </div>
    {% endfor %}
  </div>

  <div style="display:flex;gap:12px;align-items:center;">
    <button type="button" id="add-task-btn">+ Add Task</button>
    <button type="button" id="remove-task-btn">â€“ Remove Last Task</button>
    <button type="submit">Save & Continue</button>
  </div>
</form>

<script>
(function() {
  // Get formset elements
  const addBtn = document.getElementById('add-task-btn');
  const removeBtn = document.getElementById('remove-task-btn');
  const container = document.getElementById('forms-container');
  const totalFormsInput = document.getElementById('id_tasks-TOTAL_FORMS');
  const initialFormsInput = document.getElementById('id_tasks-INITIAL_FORMS');

  // Clone the last form and clear values
  function addNewForm() {
    const currentTotal = parseInt(totalFormsInput.value, 10);
    const newIndex = currentTotal;
    const lastCard = container.querySelector('.task-card:last-of-type');

    if (!lastCard) {
      alert('No existing form to clone. Please reload the page.');
      return;
    }

    // Clone and reset the form
    const clone = lastCard.cloneNode(true);
    clone.setAttribute('data-form-index', newIndex);

    clone.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.name) el.name = el.name.replace(/tasks-\d+-/, `tasks-${newIndex}-`);
      if (el.id) el.id = el.id.replace(/id_tasks-\d+-/, `id_tasks-${newIndex}-`);

      if (el.type === 'checkbox') el.checked = false;
      else if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
    });

    // Reset any delete checkbox
    const del = clone.querySelector('input[name$="-DELETE"]');
    if (del) del.checked = false;

    container.appendChild(clone);
    totalFormsInput.value = String(currentTotal + 1);
  }

  // Remove the last form 
  function removeLastForm() {
    const total = parseInt(totalFormsInput.value, 10);
    const initial = parseInt(initialFormsInput.value, 10);

    if (total > initial) {
      const lastCard = container.querySelector('.task-card:last-of-type');
      if (lastCard) {
        container.removeChild(lastCard);
        totalFormsInput.value = String(total - 1);
      }
    }
  }

  // Event listeners
  addBtn.addEventListener('click', addNewForm);
  removeBtn.addEventListener('click', removeLastForm);
})();
</script>

{% endblock %}
